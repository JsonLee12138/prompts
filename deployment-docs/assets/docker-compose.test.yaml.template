# ============================================
# 测试环境 Docker Compose 配置
# ============================================

services:
  # 前端应用
  web:
    image: registry.example.com:5000/web:latest
    container_name: web-test
    environment:
      - NODE_ENV=production
      - API_HOST=api-test
      - API_PORT=3000
    ports:
      - "18080:80"
    restart: unless-stopped
    networks:
      - test-network
    depends_on:
      - api-test

  # 后端 API
  api-test:
    image: registry.example.com:5000/api:latest
    container_name: api-test
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=postgresql://user:pass@db-test:5432/mydb_test
      - REDIS_URL=redis://redis-test:6379
    ports:
      - "18081:3000"
    restart: unless-stopped
    networks:
      - test-network
    depends_on:
      - db-test
      - redis-test

  # PostgreSQL
  db-test:
    image: postgres:15-alpine
    container_name: db-test
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=mydb_test
    volumes:
      - pgdata-test:/var/lib/postgresql/data
    networks:
      - test-network

  # Redis
  redis-test:
    image: redis:7-alpine
    container_name: redis-test
    networks:
      - test-network

  # Adminer (数据库管理，可选)
  adminer-test:
    image: adminer:latest
    container_name: adminer-test
    ports:
      - "18082:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=db-test
    networks:
      - test-network
    depends_on:
      - db-test

volumes:
  pgdata-test:

networks:
  test-network:
    driver: bridge
